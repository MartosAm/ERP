<div class="page-container">
  @if (cargando()) {
    <div class="flex justify-center py-16">
      <mat-spinner diameter="48" />
    </div>
  } @else if (orden(); as o) {
    <app-page-header
      [titulo]="'Orden ' + o.numeroOrden"
      subtitulo="Detalle de la orden"
      icono="receipt_long">
      <button mat-button (click)="volver()">
        <mat-icon>arrow_back</mat-icon> Volver
      </button>
      @if (puedeCancelar) {
        <button mat-raised-button color="warn" (click)="cancelar()">
          <mat-icon>cancel</mat-icon> Cancelar
        </button>
      }
      @if (puedeDevolver) {
        <button mat-raised-button color="accent" (click)="devolver()">
          <mat-icon>undo</mat-icon> Devolver
        </button>
      }
    </app-page-header>

    <!-- Info general -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <mat-card>
        <mat-card-content class="p-4">
          <p class="text-sm text-gray-500 mb-1">Estado</p>
          <app-estado-badge [estado]="o.estado" tipo="orden" />
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-content class="p-4">
          <p class="text-sm text-gray-500 mb-1">Cliente</p>
          <p class="font-medium">{{ o.cliente?.nombre || 'Público general' }}</p>
          @if (o.cliente?.telefono) {
            <p class="text-sm text-gray-400">{{ o.cliente.telefono }}</p>
          }
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-content class="p-4">
          <p class="text-sm text-gray-500 mb-1">Creado por</p>
          <p class="font-medium">{{ o.creadoPor.nombre }}</p>
          <p class="text-sm text-gray-400">{{ o.creadoEn | fechaHora }}</p>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Totales -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <mat-card>
        <mat-card-content class="p-4 text-center">
          <p class="text-sm text-gray-500">Subtotal</p>
          <p class="text-lg font-semibold">{{ o.subtotal | moneda }}</p>
        </mat-card-content>
      </mat-card>
      <mat-card>
        <mat-card-content class="p-4 text-center">
          <p class="text-sm text-gray-500">Impuesto</p>
          <p class="text-lg font-semibold">{{ o.montoImpuesto | moneda }}</p>
        </mat-card-content>
      </mat-card>
      <mat-card>
        <mat-card-content class="p-4 text-center">
          <p class="text-sm text-gray-500">Descuento</p>
          <p class="text-lg font-semibold text-red-600">-{{ o.montoDescuento | moneda }}</p>
        </mat-card-content>
      </mat-card>
      <mat-card>
        <mat-card-content class="p-4 text-center">
          <p class="text-sm text-gray-500">Total</p>
          <p class="text-2xl font-bold text-indigo-600">{{ o.total | moneda }}</p>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Detalles de productos -->
    <div class="card mb-6">
      <h3 class="text-base font-semibold mb-3">Productos</h3>
      <table mat-table [dataSource]="o.detalles" class="w-full">
        <ng-container matColumnDef="producto">
          <th mat-header-cell *matHeaderCellDef>Producto</th>
          <td mat-cell *matCellDef="let d">
            <span class="font-medium">{{ d.producto.nombre }}</span>
            <span class="text-xs text-gray-400 ml-2">{{ d.producto.sku }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="cantidad">
          <th mat-header-cell *matHeaderCellDef class="text-center">Cantidad</th>
          <td mat-cell *matCellDef="let d" class="text-center">{{ d.cantidad }}</td>
        </ng-container>

        <ng-container matColumnDef="precioUnitario">
          <th mat-header-cell *matHeaderCellDef class="text-right">Precio unit.</th>
          <td mat-cell *matCellDef="let d" class="text-right">{{ d.precioUnitario | moneda }}</td>
        </ng-container>

        <ng-container matColumnDef="descuento">
          <th mat-header-cell *matHeaderCellDef class="text-right">Descuento</th>
          <td mat-cell *matCellDef="let d" class="text-right">{{ d.descuento | moneda }}</td>
        </ng-container>

        <ng-container matColumnDef="subtotal">
          <th mat-header-cell *matHeaderCellDef class="text-right">Subtotal</th>
          <td mat-cell *matCellDef="let d" class="text-right font-medium">{{ d.subtotal | moneda }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="colDetalles"></tr>
        <tr mat-row *matRowDef="let row; columns: colDetalles"></tr>
      </table>
    </div>

    <!-- Pagos -->
    @if (o.pagos.length > 0) {
      <div class="card mb-6">
        <h3 class="text-base font-semibold mb-3">Pagos</h3>
        <table mat-table [dataSource]="o.pagos" class="w-full">
          <ng-container matColumnDef="metodo">
            <th mat-header-cell *matHeaderCellDef>Método</th>
            <td mat-cell *matCellDef="let p">
              <app-estado-badge [estado]="p.metodo" tipo="pago" />
            </td>
          </ng-container>

          <ng-container matColumnDef="monto">
            <th mat-header-cell *matHeaderCellDef class="text-right">Monto</th>
            <td mat-cell *matCellDef="let p" class="text-right font-medium">{{ p.monto | moneda }}</td>
          </ng-container>

          <ng-container matColumnDef="referencia">
            <th mat-header-cell *matHeaderCellDef>Referencia</th>
            <td mat-cell *matCellDef="let p">{{ p.referencia || '—' }}</td>
          </ng-container>

          <ng-container matColumnDef="fecha">
            <th mat-header-cell *matHeaderCellDef>Fecha</th>
            <td mat-cell *matCellDef="let p">{{ p.pagadoEn | fechaHora }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="colPagos"></tr>
          <tr mat-row *matRowDef="let row; columns: colPagos"></tr>
        </table>
      </div>
    }

    <!-- Entrega -->
    @if (o.entrega; as e) {
      <div class="card mb-6">
        <h3 class="text-base font-semibold mb-3">Entrega</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div>
            <p class="text-sm text-gray-500">Estado</p>
            <app-estado-badge [estado]="e.estado" tipo="entrega" />
          </div>
          <div>
            <p class="text-sm text-gray-500">Dirección</p>
            <p class="text-sm">{{ e.direccionEntrega }}</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Repartidor</p>
            <p class="text-sm">{{ e.asignadoA?.nombre || 'Sin asignar' }}</p>
          </div>
          @if (e.programadaEn) {
            <div>
              <p class="text-sm text-gray-500">Programada</p>
              <p class="text-sm">{{ e.programadaEn | fechaHora }}</p>
            </div>
          }
        </div>
      </div>
    }

    <!-- Notas / Motivo cancelación -->
    @if (o.notas || o.motivoCancelacion) {
      <div class="card">
        @if (o.notas) {
          <div class="mb-3">
            <p class="text-sm text-gray-500 mb-1">Notas</p>
            <p class="text-sm">{{ o.notas }}</p>
          </div>
        }
        @if (o.motivoCancelacion) {
          <div>
            <p class="text-sm text-red-500 mb-1">Motivo de cancelación</p>
            <p class="text-sm text-red-700">{{ o.motivoCancelacion }}</p>
          </div>
        }
      </div>
    }
  }
</div>
