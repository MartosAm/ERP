<div class="page-container">
  <app-page-header
    titulo="Categorías"
    subtitulo="Gestión del catálogo de categorías"
    icono="category">
    <button mat-raised-button color="primary" (click)="crear()">
      <mat-icon>add</mat-icon> Nueva categoría
    </button>
  </app-page-header>

  <div class="card mb-4">
    <app-search-input
      placeholder="Buscar categoría..."
      (buscar)="onBuscar($event)" />
  </div>

  @if (cargando()) {
    <div class="flex justify-center py-10">
      <mat-spinner diameter="40" />
    </div>
  } @else {
    <div class="card overflow-x-auto">
      <table mat-table [dataSource]="items()" class="w-full">

        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef>Nombre</th>
          <td mat-cell *matCellDef="let c">
            <div class="flex items-center gap-2">
              @if (c.colorHex) {
                <span class="w-3 h-3 rounded-full inline-block" [style.background]="c.colorHex"></span>
              }
              <span class="font-medium">{{ c.nombre }}</span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="padre">
          <th mat-header-cell *matHeaderCellDef>Padre</th>
          <td mat-cell *matCellDef="let c">{{ c.padre?.nombre || '—' }}</td>
        </ng-container>

        <ng-container matColumnDef="productos">
          <th mat-header-cell *matHeaderCellDef class="text-center">Productos</th>
          <td mat-cell *matCellDef="let c" class="text-center">{{ c._count.productos }}</td>
        </ng-container>

        <ng-container matColumnDef="hijos">
          <th mat-header-cell *matHeaderCellDef class="text-center">Subcategorías</th>
          <td mat-cell *matCellDef="let c" class="text-center">{{ c._count.hijos }}</td>
        </ng-container>

        <ng-container matColumnDef="activo">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let c">
            <app-estado-badge [estado]="c.activo" tipo="activo" />
          </td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef class="w-16"></th>
          <td mat-cell *matCellDef="let c">
            <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Acciones">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="editar(c)">
                <mat-icon>edit</mat-icon> Editar
              </button>
              <button mat-menu-item (click)="eliminar(c)" class="!text-red-600">
                <mat-icon class="!text-red-600">delete</mat-icon> Eliminar
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columnas"></tr>
        <tr mat-row *matRowDef="let row; columns: columnas" class="hover:bg-gray-50"></tr>
      </table>

      @if (items().length === 0) {
        <app-empty-state
          icono="category"
          mensaje="No se encontraron categorías"
          textoAccion="Crear categoría"
          (accion)="crear()" />
      }

      @if (meta()) {
        <mat-paginator
          [length]="meta()!.total"
          [pageSize]="meta()!.limite"
          [pageIndex]="meta()!.pagina - 1"
          [pageSizeOptions]="[10, 20, 50]"
          (page)="onPage($event)"
          showFirstLastButtons />
      }
    </div>
  }
</div>
