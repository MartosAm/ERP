<div class="page-container">
  <app-page-header
    titulo="Inventario"
    subtitulo="Control de existencias y movimientos"
    icono="warehouse">
    <button mat-raised-button color="primary" (click)="abrirAjuste()">
      <mat-icon>tune</mat-icon> Ajuste manual
    </button>
    <button mat-raised-button (click)="abrirTraslado()">
      <mat-icon>swap_horiz</mat-icon> Traslado
    </button>
  </app-page-header>

  <mat-tab-group (selectedIndexChange)="onTabChange($event)" animationDuration="200ms">
    <!-- ═══ Tab Existencias ═══ -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="mr-2">inventory</mat-icon> Existencias
      </ng-template>

      <div class="pt-4">
        <div class="card mb-4">
          <div class="flex flex-wrap items-end gap-3">
            <app-search-input
              class="flex-1 min-w-[200px]"
              placeholder="Buscar producto..."
              (buscar)="onBuscarExist($event)" />

            <mat-form-field appearance="outline" class="w-52">
              <mat-label>Almacén</mat-label>
              <mat-select (selectionChange)="filtrarAlmacenExist($event.value)" [value]="almacenExist">
                <mat-option value="">Todos</mat-option>
                @for (a of almacenes(); track a.id) {
                  <mat-option [value]="a.id">{{ a.nombre }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <button mat-raised-button
                    [color]="soloStockBajo ? 'warn' : ''"
                    (click)="toggleStockBajo()">
              <mat-icon>{{ soloStockBajo ? 'warning' : 'filter_list' }}</mat-icon>
              Stock bajo
            </button>
          </div>
        </div>

        @if (cargandoExist()) {
          <div class="flex justify-center py-10">
            <mat-spinner diameter="40" />
          </div>
        } @else {
          <div class="card overflow-x-auto">
            <table mat-table [dataSource]="existencias()" class="w-full">
              <ng-container matColumnDef="producto">
                <th mat-header-cell *matHeaderCellDef>Producto</th>
                <td mat-cell *matCellDef="let e">
                  <div class="flex items-center gap-2">
                    @if (esStockBajo(e)) {
                      <mat-icon class="text-red-500 !text-base">warning</mat-icon>
                    }
                    <div>
                      <span class="font-medium">{{ e.producto.nombre }}</span>
                      <span class="text-xs text-gray-400 ml-2">{{ e.producto.sku }}</span>
                    </div>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="almacen">
                <th mat-header-cell *matHeaderCellDef>Almacén</th>
                <td mat-cell *matCellDef="let e">
                  {{ e.almacen.nombre }}
                  @if (e.almacen.esPrincipal) {
                    <span class="text-xs text-gray-400">(Ppal)</span>
                  }
                </td>
              </ng-container>

              <ng-container matColumnDef="cantidad">
                <th mat-header-cell *matHeaderCellDef class="text-center">Cantidad</th>
                <td mat-cell *matCellDef="let e" class="text-center font-medium"
                    [class.text-red-600]="esStockBajo(e)">
                  {{ e.cantidad }} {{ e.producto.etiquetaUnidad }}
                </td>
              </ng-container>

              <ng-container matColumnDef="stockMinimo">
                <th mat-header-cell *matHeaderCellDef class="text-center">Mín.</th>
                <td mat-cell *matCellDef="let e" class="text-center text-gray-500">
                  {{ e.producto.stockMinimo }}
                </td>
              </ng-container>

              <ng-container matColumnDef="estado">
                <th mat-header-cell *matHeaderCellDef>Estado</th>
                <td mat-cell *matCellDef="let e">
                  @if (esStockBajo(e)) {
                    <span class="inline-flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full bg-red-100 text-red-800">
                      Stock bajo
                    </span>
                  } @else {
                    <span class="inline-flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full bg-green-100 text-green-800">
                      Normal
                    </span>
                  }
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="colExistencias"></tr>
              <tr mat-row *matRowDef="let row; columns: colExistencias" class="hover:bg-gray-50"></tr>
            </table>

            @if (existencias().length === 0) {
              <app-empty-state
                icono="inventory"
                mensaje="No se encontraron existencias"
                submensaje="Ajusta los filtros de búsqueda" />
            }

            @if (metaExist()) {
              <mat-paginator
                [length]="metaExist()!.total"
                [pageSize]="metaExist()!.limite"
                [pageIndex]="metaExist()!.pagina - 1"
                [pageSizeOptions]="[10, 20, 50]"
                (page)="onPageExist($event)"
                showFirstLastButtons />
            }
          </div>
        }
      </div>
    </mat-tab>

    <!-- ═══ Tab Movimientos ═══ -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="mr-2">swap_vert</mat-icon> Movimientos
      </ng-template>

      <div class="pt-4">
        <div class="card mb-4">
          <div class="flex flex-wrap items-end gap-3">
            <mat-form-field appearance="outline" class="w-52">
              <mat-label>Almacén</mat-label>
              <mat-select (selectionChange)="filtrarAlmacenMov($event.value)" [value]="almacenMov">
                <mat-option value="">Todos</mat-option>
                @for (a of almacenes(); track a.id) {
                  <mat-option [value]="a.id">{{ a.nombre }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-48">
              <mat-label>Tipo</mat-label>
              <mat-select (selectionChange)="filtrarTipoMov($event.value)" [value]="tipoMov">
                <mat-option value="">Todos</mat-option>
                <mat-option value="ENTRADA">Entrada</mat-option>
                <mat-option value="SALIDA_VENTA">Salida venta</mat-option>
                <mat-option value="AJUSTE_MANUAL">Ajuste manual</mat-option>
                <mat-option value="DEVOLUCION">Devolución</mat-option>
                <mat-option value="MERMA">Merma</mat-option>
                <mat-option value="TRASLADO">Traslado</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>

        @if (cargandoMov()) {
          <div class="flex justify-center py-10">
            <mat-spinner diameter="40" />
          </div>
        } @else {
          <div class="card overflow-x-auto">
            <table mat-table [dataSource]="movimientos()" class="w-full">
              <ng-container matColumnDef="fecha">
                <th mat-header-cell *matHeaderCellDef>Fecha</th>
                <td mat-cell *matCellDef="let m">{{ m.creadoEn | fechaHora }}</td>
              </ng-container>

              <ng-container matColumnDef="tipo">
                <th mat-header-cell *matHeaderCellDef>Tipo</th>
                <td mat-cell *matCellDef="let m">
                  <app-estado-badge [estado]="m.tipoMovimiento" tipo="movimiento" />
                </td>
              </ng-container>

              <ng-container matColumnDef="producto">
                <th mat-header-cell *matHeaderCellDef>Producto</th>
                <td mat-cell *matCellDef="let m">
                  <span class="font-medium">{{ m.producto.nombre }}</span>
                  <span class="text-xs text-gray-400 ml-1">{{ m.producto.sku }}</span>
                </td>
              </ng-container>

              <ng-container matColumnDef="almacen">
                <th mat-header-cell *matHeaderCellDef>Almacén</th>
                <td mat-cell *matCellDef="let m">
                  {{ m.almacen.nombre }}
                  @if (m.almacenDestino) {
                    <mat-icon class="!text-base align-middle mx-1">arrow_forward</mat-icon>
                    {{ m.almacenDestino.nombre }}
                  }
                </td>
              </ng-container>

              <ng-container matColumnDef="cantidad">
                <th mat-header-cell *matHeaderCellDef class="text-center">Cantidad</th>
                <td mat-cell *matCellDef="let m" class="text-center font-medium">{{ m.cantidad }}</td>
              </ng-container>

              <ng-container matColumnDef="anterior">
                <th mat-header-cell *matHeaderCellDef class="text-center">Anterior</th>
                <td mat-cell *matCellDef="let m" class="text-center text-gray-500">{{ m.cantidadAnterior }}</td>
              </ng-container>

              <ng-container matColumnDef="posterior">
                <th mat-header-cell *matHeaderCellDef class="text-center">Posterior</th>
                <td mat-cell *matCellDef="let m" class="text-center">{{ m.cantidadPosterior }}</td>
              </ng-container>

              <ng-container matColumnDef="usuario">
                <th mat-header-cell *matHeaderCellDef>Usuario</th>
                <td mat-cell *matCellDef="let m">{{ m.usuario.nombre }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="colMovimientos"></tr>
              <tr mat-row *matRowDef="let row; columns: colMovimientos" class="hover:bg-gray-50"></tr>
            </table>

            @if (movimientos().length === 0) {
              <app-empty-state
                icono="swap_vert"
                mensaje="No se encontraron movimientos"
                submensaje="Ajusta los filtros de búsqueda" />
            }

            @if (metaMov()) {
              <mat-paginator
                [length]="metaMov()!.total"
                [pageSize]="metaMov()!.limite"
                [pageIndex]="metaMov()!.pagina - 1"
                [pageSizeOptions]="[10, 20, 50]"
                (page)="onPageMov($event)"
                showFirstLastButtons />
            }
          </div>
        }
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
